<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<beast beautitemplate='MultiTypeBirthDeath' beautistatus='' namespace="beast.core:beast.evolution.alignment
    :beast.evolution.tree.coalescent:beast.core.util
    :beast.evolution.nuc
    :beast.evolution.operators
    :beast.evolution.sitemodel
    :beast.evolution.substitutionmodel
    :beast.base.evolution.alignment
    :beast.pkgmgmt
    :beast.base.core
    :beast.base.inference
    :beast.base.evolution.tree.coalescent
    :beast.base.core
    :beast.base.inference.util
    :beast.evolution.nuc
    :beast.base.evolution.operator
    :beast.base.inference.operator
    :beast.base.evolution.sitemodel
    :beast.base.evolution.substitutionmodel
    :beast.base.evolution.likelihood
    :beam
    :tidetree" required="BEAST.base v2.7.6:FixedTreeAnalysis v0.0.2:BEAST_CLASSIC v1.6.3" version="2.7">

<!-- syntactic sugar -->
<map name="Uniform" >beast.base.inference.distribution.Uniform</map>
<map name="Exponential" >beast.base.inference.distribution.Exponential</map>
<map name="LogNormal" >beast.base.inference.distribution.LogNormalDistributionModel</map>
<map name="Normal" >beast.base.inference.distribution.Normal</map>
<map name="Beta" >beast.base.inference.distribution.Beta</map>
<map name="Gamma" >beast.base.inference.distribution.Gamma</map>
<map name="LaplaceDistribution" >beast.base.inference.distribution.LaplaceDistribution</map>
<map name="prior" >beast.base.inference.distribution.Prior</map>
<map name="InverseGamma" >beast.base.inference.distribution.InverseGamma</map>
<map name="OneOnX" >beast.base.inference.distribution.OneOnX</map>

    
<!-- input data -->
<data  id="alignment" spec="feast.fileio.AlignmentFromFasta" fileName="/Users/staklins/projects/crispr-barcode-cancer-metastasis/beam_dev/beam/examples/3457_Apc_T4/3457_Apc_T4.fasta">
    <userDataType spec="tidetree.evolution.datatype.EditData" nrOfStates="34"/>
</data>

<taxonset id="taxonset" spec="TaxonSet" alignment="@alignment"/>

<traitSet id="dateTrait" spec="feast.fileio.TraitSetFromXSV" taxa="@taxonset" fileName="/Users/staklins/projects/crispr-barcode-cancer-metastasis/beam_dev/beam/examples/3457_Apc_T4/3457_Apc_T4_date_traits.csv" sep="," taxonNameCol="0" traitValueCol="1" skipFirstRow="false" traitname="date-forward"/>


<substModel id="substModel" spec="beam.substitutionmodel.BeamGeneralMutationSubstitutionModel" editRates="@editRate" silencingRate="@silencingRate" editHeight="185" editDuration="185">
    <frequencies spec="beast.base.evolution.substitutionmodel.Frequencies" frequencies="1.0 0 0" estimate="false"/>
</substModel>

<siteModel spec="SiteModel" id="siteModel" mutationRate="@mutationRate" proportionInvariant="@proportionInvariant" gammaCategoryCount="0" substModel="@substModel"></siteModel>

<run id="mcmc" spec="MCMC" chainLength="1000000000">
        <state id="state" spec="State" storeEvery="5000">
            <stateNode id="tree" spec="beam.tree.BeamStartingTreeFromNewick" taxa="@alignment" IsLabelledNewick="true" adjustTipHeights="true" newick="((((clone2:102.59715121756314,clone9:102.59715027627483,clone11:102.59715027627483,clone37:102.59715027627483,(clone36_0:0.25785967507900925,clone36_1:0.25785967507900925):102.33929060119583,(clone10_0:0.25785882352227535,clone10_1:0.25785882352227535):102.33929145275255):29.336614070876834,((clone7:59.38774426432156,clone8:59.38774426432156,(clone5_0:0.2578586289500135,clone5_1:0.2578586289500135):59.129885635371544,clone35:59.38774426432156):21.20433588781236,((clone6:64.67021624869396,clone1:64.67021624869396,clone34:64.67021624869396):15.664003763908953,((clone38:30.942260411118028,(clone12_0:0.25785883228827444,clone12_1:0.25785883228827444):30.68440157882975):38.701538951046885,((clone13:30.682327971546044,clone39:30.682327971546044):38.7023500106404,((clone14:30.58740794398428,clone40:30.58740794398428):38.538362595911785,((clone42:30.658303336910585,(clone15_0:0.25785870001533945,clone15_1:0.25785870001533945):30.400444636895244):38.20755723989968,((clone41:60.393010865173395,(clone32_0:0.25786099132702456,clone32_1:0.25786099132702456):60.135149873846366):2.262694926377669,(clone43:62.397830338929936,(clone44:62.13996691520284,(clone45:61.8821061502116,(clone16:61.624246654506024,(clone17:61.3663858760284,(clone46:54.18750702931506,(clone47:53.929623968794786,(clone18:53.67175749308191,(clone48:39.18800473202483,clone33:39.18800473202483):14.483752761057087):0.257866475712871):0.2578830605202735):7.1788788467133395):0.2578607784776214):0.2578594957055744):0.257860764991248):0.257863423727091):0.2578754526211251):6.210154282552839):0.2599094598059788):0.25890694443539003):0.2591208861318957):10.690420154685045):0.25786007600977806):51.34168531899114):14.968044632796973,(((clone22:38.03078091047736,clone51:38.03078091047736,clone52:38.03078091047736):34.16459512408583,((clone20:55.959799439404534,clone4:55.959799439404534,clone49:55.959799439404534):15.977716817273558,(clone31:71.67963712879425,(clone53:71.42177396115737,(clone23:71.16391366898088,(clone24:70.90604010770579,(clone25:70.64813074525183,clone30:70.64813074525183):0.2579093624539558):0.2578735612750994):0.25786029217648737):0.257863167636888):0.2578791278838326):0.2578597065224685):23.121593506711374,(clone50:76.12125721345929,(clone21:30.643115216867677,clone19:30.643115216867677):45.47814199659162):19.195712390633588):51.58484041328173):37.84033318484107,((clone54:113.50829789344867,clone3:113.50829789344867):0.2578597486022411,((clone55:26.57706619738731,clone26:26.57706619738731):86.93122991886621,(clone28:113.25042969230952,clone27:113.25042969230952,clone29:113.25042969230952):0.25786642394398657):0.25786147793132197):70.97598570422547):0.2578566537236085">
                <trait idref="dateTrait"/>
                <taxonset idref="taxonset"/>
            </stateNode>

            <parameter id="editRate" spec="parameter.RealParameter" estimate="true" name="stateNode" dimension="32">.1643002028 .1095334685 .1054766734 .1176470588 .1156186612 .1075050709 .1034482758 .0324543610 .0223123732 .0121703853 .0182555780 .0141987829 .0141987829 .0121703853 .0020283975 .0060851926 .0020283975 .0040567951 .0081135902 .0040567951 .0020283975 .0020283975 .0020283975 .0020283975 .0020283975 .0020283975 .0020283975 .0020283975 .0020283975 .0020283975 .0020283975 .0020283975</parameter>

            <!-- optional silencing rate if silencing is being modeled -->
            <parameter id="silencingRate" spec="parameter.RealParameter" dimension="1" lower="0.0" name="stateNode" upper="1000">0.0001</parameter>

            <!-- the clock rate is the rate of acquiring edited state -->
            <parameter id="clockRate.c" spec="parameter.RealParameter" name="stateNode">1.0</parameter>
            <!-- the mutation rate could be another rate multiplier, but we leave it fixed to 1 -->
            <parameter spec="parameter.RealParameter" estimate="false" id="mutationRate" name="stateNode">1.0</parameter>
            <parameter spec="parameter.RealParameter" estimate="false" lower="0.0" id="proportionInvariant" name="stateNode" upper="1.0">0.0</parameter>
            <parameter id="origin" spec="parameter.RealParameter" name="stateNode" upper="185.0001">185.001</parameter>
            <parameter id="relativeGeoRates.s:tissue" spec="parameter.RealParameter" dimension="2" name="stateNode">1.0</parameter>
            <parameter id="traitClockRate.c:tissue" spec="parameter.RealParameter" name="stateNode">1.0</parameter>
            <parameter id="tissueRateIndicators" spec="parameter.BooleanParameter" dimension="2" name="stateNode">true</parameter>

            <!-- birth rate corresponds to cell division rate -->
            <parameter id="birthRate" spec="parameter.RealParameter" dimension="1" lower="0.0" name="stateNode" upper="5">0.6</parameter>
            <!-- death rate corresponds to apoptosis rate -->
            <parameter id="deathRate" spec="parameter.RealParameter" dimension="1" lower="0.0" name="stateNode" upper="5">0.01</parameter>

        </state>
        
        
        <distribution id="posterior" spec="CompoundDistribution">
            
            <distribution id="prior" spec="CompoundDistribution">

                <distribution id="birthDeathSamplingModel" spec="bdsky.evolution.speciation.BirthDeathSkylineModel"
                          conditionOnSurvival="True" tree="@tree" origin="@origin" contemp="true"
                          birthRate="@birthRate" deathRate="@deathRate" rho="1.0"
                          samplingRate="0.0" >
                </distribution>

                <prior id="editRatePrior" name="distribution" x="@editRate">
                    <Exponential name="distr">
                        <parameter spec="parameter.RealParameter" estimate="false" name="mean">0.01</parameter>
                    </Exponential>
                </prior>

                <!-- optional silencing rate prior if silencing is being modeled -->
                <prior id="silencingRatePrior" name="distribution" x="@silencingRate">
                    <Exponential name="distr">
                        <parameter spec="parameter.RealParameter" estimate="false" name="mean">0.0001</parameter>
                    </Exponential>
                </prior>

                <prior id="ClockPrior.c" name="distribution" x="@clockRate.c">
                    <Uniform name="distr" lower="0.0" upper="Infinity"/>
                </prior>

                <prior id="relativeGeoRatesPrior.s:tissue" name="distribution" x="@relativeGeoRates.s:tissue">
                    <Exponential name="distr">
                        <parameter spec="parameter.RealParameter" estimate="false" name="mean">1.0</parameter>
                    </Exponential>
                </prior>
                <prior id="geoclockPrior.c:tissue" name="distribution" x="@traitClockRate.c:tissue">
                    <Uniform name="distr" lower="0.0" upper="Infinity"/>
                </prior>


                <!-- prior distributions on phylodynamic parameters -->
                <prior id="birthRatePrior" name="distribution" x="@birthRate">
                    <Uniform name="distr" lower="0.0" upper="5.0"/>
                </prior>
                
                <prior id="deathRatePrior" name="distribution" x="@deathRate">
                    <Uniform name="distr" lower="0.0" upper="5.0"/>
                </prior>


            </distribution>
            
            
            <distribution id="likelihood" spec="CompoundDistribution" useThreads="true">
                
                <distribution id="treeLikelihood" spec="beam.likelihood.BeamBeagleTreeLikelihood" origin="185.001" data="@alignment" tree="@tree" siteModel="@siteModel">
                    <branchRateModel spec="beast.base.evolution.branchratemodel.StrictClockModel" clock.rate="@clockRate.c"/>
                </distribution>
                
                <distribution id="traitLikelihood" spec="beam.likelihood.BeamAncestralStateBeagleTreeLikelihood" origin="@origin" tag="location" tree="@tree">
                    <rootFrequencies spec="beast.base.evolution.substitutionmodel.Frequencies" frequencies="1 0" estimate="false"/>
                    <data id="tissue" spec="beastclassic.evolution.alignment.AlignmentFromTrait">
                        <traitSet id="traitset" spec="feast.fileio.TraitSetFromXSV" fileName="/Users/staklins/projects/crispr-barcode-cancer-metastasis/beam_dev/beam/examples/3457_Apc_T4/3457_Apc_T4_tip_tissues.csv" taxa="@taxonset" taxonNameCol="0" skipFirstRow="false" sep="," traitname="discrete"/>
                        <userDataType id="codeMap" spec="beast.base.evolution.datatype.UserDataType" codeMap="T=0,L=1,? = 0 1" codelength="-1" states="2"/>
                    </data>
                    <siteModel id="geoSiteModel.s:tissue" spec="SiteModel" gammaCategoryCount="1">
                        <parameter id="mutationRate.s:tissue" spec="parameter.RealParameter" estimate="false" name="mutationRate">1.0</parameter>
                        <parameter id="gammaShape.s:tissue" spec="parameter.RealParameter" estimate="false" name="shape">1.0</parameter>
                        <parameter id="proportionInvariant.s:tissue" spec="parameter.RealParameter" estimate="false" lower="0.0" name="proportionInvariant" upper="1.0">0.0</parameter>
                        <substModel id="svs.s:tissue" spec="beastclassic.evolution.substitutionmodel.SVSGeneralSubstitutionModel" rates="@relativeGeoRates.s:tissue" rateIndicator="@tissueRateIndicators" symmetric="false">
                            <frequencies id="traitfreqs.s:tissue" spec="Frequencies">
                                <parameter id="traitfrequencies.s:tissue" spec="parameter.RealParameter" dimension="2" name="frequencies">0.500000000</parameter>
                            </frequencies>
                        </substModel>
                    </siteModel>
                    <branchRateModel id="StrictClockModel.c:tissue" spec="beast.base.evolution.branchratemodel.StrictClockModel" clock.rate="@traitClockRate.c:tissue"/>
                </distribution>
                
            </distribution>
            
        </distribution>
        
    <!-- tree operators -->
    <operator  spec="Uniform" tree="@tree" weight="30.0"/>
    <operator  spec="SubtreeSlide" tree="@tree" weight="3.0"/>
    <operator spec="SubtreeSlide" tree="@tree" weight="3.0" size="30"/>
    <operator  spec="Exchange" isNarrow="false" tree="@tree" weight="30.0"/>

    <!-- operators on phylogenetic parameters-->
    <!-- operator on edit probabilities while keeping their sum fixed to 1 -->
    <operator id="editRateScaler" spec="DeltaExchangeOperator" parameter="@editRate" weight="3.0"/>
    <operator id="clockRateScaler" spec="ScaleOperator" parameter="@clockRate.c" scaleFactor="0.8" weight="3.0"/>
    <operator id="silencingRateScaler" spec="ScaleOperator" parameter="@silencingRate" scaleFactor="0.8" weight="3.0"/>
        
    <!-- operators on ancestral state model sparameters -->
    <operator id="georateScaler.s:tissue" spec="ScaleOperator" parameter="@relativeGeoRates.s:tissue" scaleAllIndependently="true" scaleFactor="0.99" weight="30.0"/>
    <operator id="geoMuScaler.c:tissue" spec="ScaleOperator" parameter="@traitClockRate.c:tissue" scaleFactor="0.9" weight="3.0"/>
    

    <!-- Operators on phylodynamic parameters -->
    <operator id="birthRateScaler" spec="ScaleOperator" parameter="@birthRate" scaleFactor="0.8" weight="3.0"/>
    <operator id="deathRateScaler" spec="ScaleOperator" parameter="@deathRate" scaleFactor="0.8" weight="3.0"/>

    <operator id="updownBD.t:LTv2_EBd32_cluster_1" spec="UpDownOperator" scaleFactor="0.8" weight="30.0">
         <up idref="birthRate"/>
         <down idref="deathRate"/>
    </operator>


    <!-- loggers -->
        <logger id="tracelog" spec="Logger" fileName="chain_2.log" logEvery="10000" model="@posterior" sanitiseHeaders="true" sort="smart">
            <log idref="posterior"/>
            <log idref="likelihood"/>
            <log idref="prior"/>
            <log id="treeHeight" spec="beast.base.evolution.tree.TreeHeightLogger" tree="@tree"/>
            <log idref="editRate"/>
            <log idref="silencingRate" />
            <log idref="clockRate.c"/>
            <log idref="relativeGeoRates.s:tissue"/>
            <log idref="traitClockRate.c:tissue"/>
            <log id="geoSubstModelLogger.s:tissue" spec="beastclassic.evolution.substitutionmodel.SVSGeneralSubstitutionModelLogger" dataType="@codeMap" model="@svs.s:tissue"/>
            <log idref="treeLikelihood"/>
            <log idref="traitLikelihood"/>
            <log idref="birthRate"/>
            <log idref="deathRate"/>
        </logger>

        <logger id="screenlog" spec="Logger" logEvery="10000">
            <log idref="posterior"/>
            <log id="ESS" spec="util.ESS" arg="@posterior"/>
            <log idref="likelihood"/>
            <log idref="prior"/>
        </logger>

        <logger id="treeWithTraitLogger" spec="Logger" fileName="chain_2.trees" logEvery="10000" mode="tree">
                <log id="treeWithTraitLoggerItem" spec="beastclassic.evolution.tree.TreeWithTraitLogger" tree="@tree">
                    <metadata idref="posterior"/>
                    <metadata idref="treeLikelihood"/>
                    <metadata idref="traitLikelihood"/>
                </log>
        </logger>

        <!-- log tree -->
        <logger id="treelog.t:cluster" spec="Logger" fileName="chain_2_no_trait.trees" logEvery="10000" mode="tree">
                    <log idref="tree" printMetaData="true"/>
        </logger>

    <operatorschedule id="OperatorSchedule" spec="OperatorSchedule"/>
</run>

</beast>
